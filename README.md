# MEDODS Test task
Тестовое задание на позицию Golang Junior в MEDODS.

## Описание
Данный проект представляет собой часть сервиса авторизации, реализованный с помощью Go.

Для реализации использовались следующие инструменты:
- Postgres
- Docker / Docker Compose
- [Webhook Tester](https://github.com/tarampampam/webhook-tester#readme) для удобства тестирования вебхуков в докере.

Сам сервер предоставляет 4 конечные точки:
1. Получение пары access + refresh токенов для заданного в запросе GUID
2. Получение нового access токена при помощи refresh токена.
   - Будет выполнена автоматическая деавторизация пользователя, если User-Agent не совпадает с тем, что был использован
   при выполнении операции 1
   - Если IP запроса не совпадает с тем, с которого была выполнена авторизация, сервис оповестит с помощью Webhook запроса
   указанный сервис
3. `(*)` Получение GUID на основе авторизации
4. `(*)` Деавторизация пользователя. После операции деавторизации дальнейшее использование refresh токена невозможно, а
все еще не протухшие access токены будут выдавать 401

> `(*)` - операция, требующая Bearer токен авторизации в Authorization заголовке

## Тестирование
В проекте присутствует docker-compose файл, который может быть запущен с помощью

```shell
docker-compose -f docker-compose.yml up -d
```

Это создаст 3 контейнера:
- `auth_server` - сам контейнер приложения, собственно. Может занять некоторое время для сборки в первый раз
- `db` - контейнер с Postgres
- `webhook_tester` - контейнер для тестирования вебхуков

Контейнер `auth_server` уже настроен для удобного тестирования, но даже предлагает набор переменных окружения 
для конфигурации:

- `AUTH_PORT` - порт, на котором запустится приложение. `8080` по умолчанию
- `AUTH_WEBHOOK_URL` - URL, на который приложение будет отправлять POST запросы с оповещениями о смене IP
- `AUTH_DB_URL` - URL строка для подключения к базе данных (формат `postgres://...`)
- `AUTH_JWT_KEY` - ключ для подписи JWT access токенов
- `AUTH_TOKEN_TTL` - время жизни access токенов. Допускаются строки, которые могут быть распознаны при помощи [time.ParseDuration](https://pkg.go.dev/time#ParseDuration). `5m` (5 минут) по умолчанию.
- `AUTH_SESSION_TTL` - время жизни refresh токенов. Формат как у `AUTH_TOKEN_TTL`. `1h` (1 час) по умолчанию
- `AUTH_MIGRATIONS_SOURCE` - путь к папке с миграциями внутри контейнера. Формат `file://<path>`. Если не указано, миграции не будут
запущены. `(*)`

> `(*)` приложение запускает миграции автоматически при старте в случае появления новых миграционных файлов. Путь миграциям
> уже настроен внутри `docker-compose.yml`

#### Swagger
Для отправки тестовых запросов можно использовать Swagger интерфейс, находящийся по адресу
[http://localhost:8080/swagger/index.html](http://localhost:8080/swagger/index.html).

> [!NOTE]
> При установке токена не забудьте префикс `Bearer` в начале. 
>
> Хоть OpenAPI и поддерживает BearerAuth без надобности вручную писать Bearer префикс, текущая последняя стабильная
> версия кодогенерации Swagger для Go не поддерживает этот формат. 

#### Webhooks
Так как докер создает свою сеть внутри Compose, я посчитал, что удобнее всего тестировать вебхуки будет при помощи
другого сервиса в докере. 

После запуска Docker Compose, по адресу http://localhost:3000/s/c80f5ead-a560-41d5-9c3e-74ca69be0883 будет доступен
интерфейс для отслеживания приходящих от приложения вебхуков (приложение уже настроено отсылать ивенты именно на этот адрес).

> Обратите внимание, что по этому адресу лучше переходить уже после того, как вы совершили действие, которое должно вызвать отправку
> вебхука (смена рефреша после смены API). Webhook Tester создает сессию только после того, как первый вебхук поступит, 
> иначе вас перенаправит на другую сессию с другим UUID.

